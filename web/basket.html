<!DOCTYPE html>
<html>
<head lang="en">
  <title>Request Basket</title>
  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
  <!--link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/flatly/bootstrap.min.css"-->

  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

  <style>
    body { padding-top: 70px; }
    h1 { margin-top: 2px; }
    #more { margin-left: 40px; }
  </style>

  <script >
  (function($) {
    function getBasketName() {
      return new RegExp("[\\?&]name=([^&#]*)").exec(location.search)[1];
    }

    var name = getBasketName();
    var token;

    function onAjaxError(jqXHR) {
      if (jqXHR.status == 401) {
        $("#token_message").modal({ keyboard : false });
      } else {
        $("#error_message_label").html("HTTP " + jqXHR.status + " - " + jqXHR.statusText);
        $("#error_message_text").html(jqXHR.responseText);
        $("#error_message").modal();
      }
    }

    function addRequests(data) {
      $("#requests").html("<pre>" + JSON.stringify(data) + "</pre>");
    }

    function fetchRequests() {
      $.ajax({
        method: "GET",
        url: "/baskets/" + name + "/requests",
        headers: {
          "Authorization" : token
        }
      }).done(addRequests).fail(onAjaxError);
    }

    // Initialization
    $(document).ready(function() {
      $("#name").html("Basket: " + name);
      $("#token_message").on("hidden.bs.modal", function (event) {
        token = $("#basket_token").val();
        fetchRequests();
      });

      fetchRequests();
    });
  })(jQuery);
  </script>
</head>
<body>
  <!-- Fixed navbar -->
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <a class="navbar-brand" href="/web">Request Basket</a>
      </div>
    </div>
  </nav>

  <!-- Error message -->
  <div class="modal fade" id="error_message" tabindex="-1" role="dialog" aria-labelledby="error_message_label">
    <div class="modal-dialog" role="document">
      <div class="modal-content panel-danger">
        <div class="modal-header panel-heading">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="error_message_label">HTTP error</h4>
        </div>
        <div class="modal-body">
          <p id="error_message_text"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Login dialog -->
  <div class="modal fade" id="token_message" tabindex="-1" role="dialog" aria-labelledby="token_message_label">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="token_message_label">Token requred</h4>
        </div>
        <div class="modal-body">
          <p>You are not authorized to access this basket. Please enter this basket token, or choose another basket.</p>
          <form>
            <div class="form-group">
              <label for="basket_token" class="control-label">Token:</label>
              <input type="text" class="form-control" id="basket_token">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" data-dismiss="modal">Authorize</button>
          <a href="/web" class="btn btn-default">Show Baskets</a>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-md-4">
        <h1 id="name">Basket: </h1>
      </div>
    </div>
    <hr/>
    <div id="requests">
    </div>
  </div>
</body>
</html>
