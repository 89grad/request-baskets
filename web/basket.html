<!DOCTYPE html>
<html>
<head lang="en">
  <title>Request Basket</title>
  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
  <!--link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/flatly/bootstrap.min.css"-->

  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

  <style>
    body { padding-top: 70px; }
    h1 { margin-top: 2px; }
    #more { margin-left: 100px; }
  </style>

  <script >
  (function($) {
    function getBasketName() {
      return new RegExp("[\\?&]name=([^&#]*)").exec(location.search)[1];
    }

    var name = getBasketName();
    var requestsCount = 0;

    function onAjaxError(jqXHR) {
      if (jqXHR.status == 401) {
        $("#token_message").modal({ keyboard : false });
      } else {
        $("#error_message_label").html("HTTP " + jqXHR.status + " - " + jqXHR.statusText);
        $("#error_message_text").html(jqXHR.responseText);
        $("#error_message").modal();
      }
    }

    function escapeHTML(value) {
      return value.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function renderRequest(id, request) {
      var path = request.path;
      if (request.query) {
        path += "?";
        if (request.query.length > 70) {
          path += request.query.substring(0, 67) + "...";
        } else {
          path += request.query;
        }
      }

      var headers = [];
      Object.keys(request.headers).map(function(header) {
        headers.push(header + ": " + request.headers[header].join(','));
      });

      var headerClass = "default";
      switch(request.method) {
        case "GET":
          headerClass = "success";
          break;
        case "PUT":
          headerClass = "info";
          break;
        case "POST":
          headerClass = "primary";
          break;
        case "DELETE":
          headerClass = "danger";
          break;
      }

      var html = '<div class="row"><div class="col-md-1"><h4 class="text-' + headerClass + '">[' + request.method +
        ']</h4></div><div class="col-md-11"><div class="panel-group" id="' + id + '">' +
        '<div class="panel panel-' + headerClass + '"><div class="panel-heading"><h4 class="panel-title">' + path + '</h4></div></div>' +
        '<div class="panel panel-default"><div class="panel-heading"><h4 class="panel-title">' +
        '<a class="collapsed" data-toggle="collapse" data-parent="#' + id + '" href="#' + id + '_headers">Headers</a></h4></div>' +
        '<div id="' + id + '_headers" class="panel-collapse collapse">' +
        '<div class="panel-body"><pre>' + headers.join('\n') + '</pre></div></div></div>';

      if (request.query) {
        html += '<div class="panel panel-default"><div class="panel-heading"><h4 class="panel-title">' +
          '<a class="collapsed" data-toggle="collapse" data-parent="#' + id + '" href="#' + id + '_query">Query Params</a></h4></div>' +
          '<div id="' + id + '_query" class="panel-collapse collapse">' +
          '<div class="panel-body"><pre>' + request.query.split('&').join('\n') + '</pre></div></div></div>';
      }

      if (request.body) {
        html += '<div class="panel panel-default"><div class="panel-heading"><h4 class="panel-title">' +
          '<a class="collapsed" data-toggle="collapse" data-parent="#' + id + '" href="#' + id + '_body">Body</a></h4></div>' +
          '<div id="' + id + '_body" class="panel-collapse collapse in">' +
          '<div class="panel-body"><pre>' + escapeHTML(request.body) + '</pre></div></div></div>';
      }

      html += '</div></div></div><hr/>';

      return html;
    }

    function addRequests(data) {
      if (data && data.requests) {
        var requests = $("#requests");
        var index;
        for (index = 0; index < data.requests.length; ++index) {
          requests.append(renderRequest("req" + requestsCount, data.requests[index]));
          requestsCount++;
        }

        if (data.has_more) {
          $("#more").removeClass("hide");
        } else {
          $("#more").addClass("hide");
        }
      }
    }

    function fetchRequests() {
      $.ajax({
        method: "GET",
        url: "/baskets/" + name + "/requests?skip=" + requestsCount,
        headers: {
          "Authorization" : sessionStorage.getItem("token_" + name)
        }
      }).done(addRequests).fail(onAjaxError);
    }

    // Initialization
    $(document).ready(function() {
      $("#name").html("Basket: " + name);
      $("#token_message").on("hidden.bs.modal", function (event) {
        sessionStorage.setItem("token_" + name, $("#basket_token").val());
        fetchRequests();
      });
      $("#fetch_more").on("click", function(event) {
        fetchRequests();
      });

      fetchRequests();
    });
  })(jQuery);
  </script>
</head>
<body>
  <!-- Fixed navbar -->
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <a class="navbar-brand" href="/web">Request Basket</a>
      </div>
    </div>
  </nav>

  <!-- Error message -->
  <div class="modal fade" id="error_message" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content panel-danger">
        <div class="modal-header panel-heading">
          <h4 class="modal-title" id="error_message_label">HTTP error</h4>
        </div>
        <div class="modal-body">
          <p id="error_message_text"></p>
        </div>
        <div class="modal-footer">
          <a href="/web" class="btn btn-default">Show Baskets</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Login dialog -->
  <form>
  <div class="modal fade" id="token_message" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content panel-success">
        <div class="modal-header panel-heading">
          <h4 class="modal-title" id="token_message_label">Token requred</h4>
        </div>
        <div class="modal-body">
          <p>You are not authorized to access this basket. Please enter this basket token, or choose another basket.</p>
          <div class="form-group">
            <label for="basket_token" class="control-label">Token:</label>
            <input type="password" class="form-control" id="basket_token">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success" data-dismiss="modal">Authorize</button>
          <a href="/web" class="btn btn-default">Show Baskets</a>
        </div>
      </div>
    </div>
  </div>
  </form>

  <div class="container">
    <div class="row">
      <div class="col-md-4">
        <h1 id="name">Basket: </h1>
      </div>
    </div>
    <hr/>
    <div id="requests">
    </div>
    <div id="more" class="hide">
      <a id="fetch_more" href="#" class="btn btn-default">more...</a>
    </div>
  </div>

  <p>&nbsp;</p>
</body>
</html>
